import{_ as t,c as n,o as l,ah as h,j as i,a}from"./chunks/framework.B6i8j-aH.js";const x=JSON.parse('{"title":"RKNN Whisper 구현 실전 가이드","description":"","frontmatter":{},"headers":[],"relativePath":"ai-app/voice.md","filePath":"ai-app/voice.md"}'),p={name:"ai-app/voice.md"},e={id:"pytorch-rightarrow-onnx-encoder-export",tabindex:"-1"},k={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},r={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.025ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.262ex",height:"1.181ex",role:"img",focusable:"false",viewBox:"0 -511 1000 522","aria-hidden":"true"},d={id:"onnx-rightarrow-rknn-변환",tabindex:"-1"},E={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},o={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.025ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.262ex",height:"1.181ex",role:"img",focusable:"false",viewBox:"0 -511 1000 522","aria-hidden":"true"};function g(y,s,c,F,u,m){return l(),n("div",null,[s[10]||(s[10]=h(`<h1 id="rknn-whisper-구현-실전-가이드" tabindex="-1">RKNN Whisper 구현 실전 가이드 <a class="header-anchor" href="#rknn-whisper-구현-실전-가이드" aria-label="Permalink to “RKNN Whisper 구현 실전 가이드”">​</a></h1><p>RKNN으로 Whisper를 구동할 때 가장 중요한 핵심은 <strong>&quot;Encoder는 NPU로, Decoder는 CPU(혹은 최적화된 NPU)로 처리한다&quot;</strong>는 전략입니다. Whisper의 구조적 특성상 전체를 NPU에 올리는 것은 비효율적이기 때문입니다.</p><h2 id="기초-이론-whisper-구조와-npu-가속-전략" tabindex="-1">기초 이론: Whisper 구조와 NPU 가속 전략 <a class="header-anchor" href="#기초-이론-whisper-구조와-npu-가속-전략" aria-label="Permalink to “기초 이론: Whisper 구조와 NPU 가속 전략”">​</a></h2><h3 id="whisper의-구조" tabindex="-1">Whisper의 구조 <a class="header-anchor" href="#whisper의-구조" aria-label="Permalink to “Whisper의 구조”">​</a></h3><p>Whisper는 Transformer 기반의 Encoder-Decoder 구조입니다.</p><ul><li><strong>Encoder (무거움)</strong>: 오디오(Mel Spectrogram)를 입력받아 압축된 특징(Feature)을 추출합니다. 연산량이 많지만 구조가 고정적이라 <strong>NPU 가속에 매우 적합</strong>합니다.</li><li><strong>Decoder (가벼움/복잡함)</strong>: 텍스트를 생성합니다. 이전 토큰을 기반으로 다음 토큰을 예측하는 반복(Loop) 구조이며, KV Cache를 사용합니다. 동적 크기 때문에 <strong>CPU에서 처리</strong>하는 것이 일반적인 구현 방식입니다.</li></ul><h3 id="rknn-전략" tabindex="-1">RKNN 전략 <a class="header-anchor" href="#rknn-전략" aria-label="Permalink to “RKNN 전략”">​</a></h3><ul><li><strong>Audio Encoder</strong>: <code>.rknn</code> 모델로 변환하여 NPU에서 실행.</li><li><strong>Text Decoder</strong>: <code>whisper.cpp</code> 같은 경량화된 C++ 라이브러리를 사용하여 CPU(Arm Core)에서 실행하거나, ONNX Runtime 등으로 CPU 구동.</li></ul><h2 id="환경-설정" tabindex="-1">환경 설정 <a class="header-anchor" href="#환경-설정" aria-label="Permalink to “환경 설정”">​</a></h2><h3 id="pc-x86-64-linux-추천-모델-변환용" tabindex="-1">PC (x86_64, Linux 추천) - 모델 변환용 <a class="header-anchor" href="#pc-x86-64-linux-추천-모델-변환용" aria-label="Permalink to “PC (x86_64, Linux 추천) - 모델 변환용”">​</a></h3><p>RKNN 모델 변환은 보드가 아닌 성능 좋은 PC에서 수행해야 합니다.</p><ol><li><strong>Anaconda/Miniconda 설치</strong></li><li><strong>RKNN-Toolkit2 설치</strong>:<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/airockchip/rknn-toolkit2</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rknn-toolkit2/rknn-toolkit2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> packages/rknn_toolkit2-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.whl</span></span></code></pre></div></li><li><strong>PyTorch &amp; OpenAI Whisper 설치</strong>:<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> torch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openai-whisper</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> onnx</span></span></code></pre></div></li></ol><h3 id="보드-rk3588-등-실행용" tabindex="-1">보드 (RK3588 등) - 실행용 <a class="header-anchor" href="#보드-rk3588-등-실행용" aria-label="Permalink to “보드 (RK3588 등) - 실행용”">​</a></h3><ol><li><strong>RKNPU2 드라이버 확인</strong>: 최신 펌웨어 설치.</li><li><strong>rknn-toolkit2-lite (Python) 혹은 rknn-api (C++)</strong> 라이브러리 설치.</li></ol><h2 id="모델-변환-step-by-step" tabindex="-1">모델 변환 (Step-by-Step) <a class="header-anchor" href="#모델-변환-step-by-step" aria-label="Permalink to “모델 변환 (Step-by-Step)”">​</a></h2><p>이 과정이 가장 중요합니다. PyTorch 모델에서 Encoder만 떼어내어 RKNN으로 만듭니다.</p>`,16)),i("h3",e,[s[2]||(s[2]=a("PyTorch ",-1)),i("mjx-container",k,[(l(),n("svg",r,[...s[0]||(s[0]=[i("g",{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"scale(1,-1)"},[i("g",{"data-mml-node":"math"},[i("g",{"data-mml-node":"mo"},[i("path",{"data-c":"2192",d:"M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z",style:{"stroke-width":"3"}})])])],-1)])])),s[1]||(s[1]=i("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[i("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[i("mo",{stretchy:"false"},"→")])],-1))]),s[3]||(s[3]=a(" ONNX (Encoder Export) ",-1)),s[4]||(s[4]=i("a",{class:"header-anchor",href:"#pytorch-rightarrow-onnx-encoder-export","aria-label":"Permalink to “PyTorch  ONNX (Encoder Export)”"},"​",-1))]),s[11]||(s[11]=h(`<div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> onnx</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 모델 로드 (예: tiny, base, small)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper.load_model(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;base&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">encoder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> model.encoder</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">encoder.eval()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 더미 입력 생성 (Batch, Mel_bins, Time)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Whisper base는 80 mel bins, 3000 frames (30초)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dummy_input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. ONNX로 내보내기</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.onnx.export(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    encoder,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dummy_input,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;whisper_encoder.onnx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    opset_version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    input_names</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mel&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    output_names</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_hidden_state&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    dynamic_axes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # NPU 고정 입력을 위해 dynamic axes 비활성화 권장</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ONNX Export 완료!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div>`,1)),i("h3",d,[s[7]||(s[7]=a("ONNX ",-1)),i("mjx-container",E,[(l(),n("svg",o,[...s[5]||(s[5]=[i("g",{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"scale(1,-1)"},[i("g",{"data-mml-node":"math"},[i("g",{"data-mml-node":"mo"},[i("path",{"data-c":"2192",d:"M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z",style:{"stroke-width":"3"}})])])],-1)])])),s[6]||(s[6]=i("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[i("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[i("mo",{stretchy:"false"},"→")])],-1))]),s[8]||(s[8]=a(" RKNN 변환 ",-1)),s[9]||(s[9]=i("a",{class:"header-anchor",href:"#onnx-rightarrow-rknn-변환","aria-label":"Permalink to “ONNX  RKNN 변환”"},"​",-1))]),s[12]||(s[12]=h(`<div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rknn.api </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> RKNN</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. RKNN 객체 생성</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rknn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RKNN()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 설정 (RK3588 기준)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rknn.config(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mean_values</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">std_values</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">target_platform</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;rk3588&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. ONNX 로드</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;--&gt; Loading ONNX model&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rknn.load_onnx(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./whisper_encoder.onnx&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Load model failed!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    exit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ret)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 4. 모델 빌드 (FP16이 NPU 성능/정확도 밸런스가 좋음)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;--&gt; Building model&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rknn.build(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">do_quantization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 혹은 True로 설정하여 i8 양자화 시도 가능</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Build model failed!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    exit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ret)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 5. RKNN 저장</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;--&gt; Export rknn model&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rknn.export_rknn(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./whisper_encoder.rknn&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Export rknn model failed!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    exit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ret)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;RKNN 변환 완료!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h2 id="추론-구현-board-side" tabindex="-1">추론 구현 (Board Side) <a class="header-anchor" href="#추론-구현-board-side" aria-label="Permalink to “추론 구현 (Board Side)”">​</a></h2><p>보드에서는 Python 또는 C++로 추론을 수행합니다. 여기서는 이해하기 쉬운 Python 예시를 듭니다.</p><h3 id="python-추론-코드-간소화-버전" tabindex="-1">Python 추론 코드 (간소화 버전) <a class="header-anchor" href="#python-추론-코드-간소화-버전" aria-label="Permalink to “Python 추론 코드 (간소화 버전)”">​</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numpy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rknn.api </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RKNNLite </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 보드에서는 Lite 버전 사용</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 오디오 전처리 (Whisper 라이브러리 활용)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">audio </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper.load_audio(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;test.wav&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">audio </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper.pad_or_trim(audio)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper.log_mel_spectrogram(audio).numpy()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np.expand_dims(mel, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">axis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># (1, 80, 3000)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. RKNN 초기화 및 Encoder 실행</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rknn_lite </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RKNNLite()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rknn_lite.load_rknn(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./whisper_encoder.rknn&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rknn_lite.init_runtime(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">core_mask</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RKNNLite.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NPU_CORE_0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># NPU 추론 (Encoder)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">outputs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rknn_lite.inference(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">inputs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[mel])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">npu_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.from_numpy(outputs[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 결과: (1, 1500, 512) 등</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. Decoder 실행 (CPU)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 원본 Whisper 모델의 디코더에 NPU가 계산한 feature를 주입</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper.load_model(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;base&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">options </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> whisper.DecodingOptions()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> model.decode(npu_features, options)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;결과:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result.text)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 리소스 해제</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rknn_lite.release()</span></span></code></pre></div><h2 id="추천-오픈소스-및-학습-자료" tabindex="-1">추천 오픈소스 및 학습 자료 <a class="header-anchor" href="#추천-오픈소스-및-학습-자료" aria-label="Permalink to “추천 오픈소스 및 학습 자료”">​</a></h2><p>처음부터 모두 구현하기 어렵다면, 이미 잘 만들어진 프로젝트를 분석하는 것이 가장 빠른 학습법입니다.</p><h3 id="rockchip-linux-rknn-toolkit2-공식" tabindex="-1">rockchip-linux/rknn-toolkit2 (공식) <a class="header-anchor" href="#rockchip-linux-rknn-toolkit2-공식" aria-label="Permalink to “rockchip-linux/rknn-toolkit2 (공식)”">​</a></h3><ul><li>Rockchip 공식 예제 폴더(<code>examples</code>)에 Whisper가 포함되어 있는 경우가 있습니다. (버전에 따라 다름)</li></ul><h3 id="useful-rknn-whisper-rknn-추천" tabindex="-1">useful-rknn / whisper-rknn (추천) <a class="header-anchor" href="#useful-rknn-whisper-rknn-추천" aria-label="Permalink to “useful-rknn / whisper-rknn (추천)”">​</a></h3><p>Github에서 <code>useful-transformers</code> 혹은 <code>rknn-whisper</code>를 검색하면 나오는 프로젝트들은 대부분 <strong>Encoder(NPU) + Decoder(CPU)</strong> 방식을 사용합니다.</p><ul><li><strong>aishell</strong>: 중국 개발자 커뮤니티에서 Rockchip용 Whisper 포팅이 활발합니다.</li><li><strong>monitor-lizard/rknn-whisper</strong>: 이와 유사한 프로젝트를 찾아보시면 C++ 기반의 고성능 구현체를 볼 수 있습니다.</li></ul><h3 id="whisper-cpp-활용" tabindex="-1">whisper.cpp 활용 <a class="header-anchor" href="#whisper-cpp-활용" aria-label="Permalink to “whisper.cpp 활용”">​</a></h3><p>가장 현실적인 고성능 솔루션은 <strong>whisper.cpp</strong> 프로젝트가 RK3588의 NPU를 지원하는지 확인하는 것입니다. 최근 whisper.cpp는 다양한 백엔드를 지원하려 노력 중이며, 일부 포크(Fork) 버전에서 RKNN 백엔드를 실험적으로 지원합니다.</p><h2 id="요약-학습-포인트" tabindex="-1">요약 (학습 포인트) <a class="header-anchor" href="#요약-학습-포인트" aria-label="Permalink to “요약 (학습 포인트)”">​</a></h2><ol><li><strong>변환 대상 선정</strong>: Whisper 전체를 변환하려 하지 말고 <strong>Encoder</strong>만 변환하십시오.</li><li><strong>데이터 타입</strong>: <code>FP16</code> 모드로 빌드하는 것이 정확도에 좋습니다. <code>INT8</code> 양자화는 소리 인식률을 크게 떨어뜨릴 수 있습니다.</li><li><strong>하이브리드 파이프라인</strong>: Python에서 <code>RKNNLite</code>(Encoder)와 <code>PyTorch</code>(Decoder)를 섞어 쓰는 방식으로 프로토타입을 먼저 만드세요. 그 후 C++로 이식하여 속도를 최적화하는 순서를 추천합니다.</li></ol>`,16))])}const A=t(p,[["render",g]]);export{x as __pageData,A as default};
